name: PR Light CI

on:
  pull_request:
    paths-ignore:
      - "**/*.md"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  rust-checks:
    name: Rust Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Setup stable Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Enable caching
        uses: Swatinem/rust-cache@v2
      - name: Rust fmt check
        run: cargo +stable fmt --all -- --check --color always

  host-regression:
    name: Host Regression and Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Setup stable Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Enable caching
        uses: Swatinem/rust-cache@v2
      - name: Install rust-code-analysis-cli
        run: cargo install --locked rust-code-analysis-cli --version 0.0.25
      - name: Install rust-analyzer component
        run: rustup component add rust-analyzer
      - name: Run host config regression suite
        run: scripts/test_event_config_host.sh
      - name: Run host event engine suite
        run: scripts/test_event_engine_host.sh
      - name: Run host touch core unit suite
        run: scripts/test_touch_core_host.sh
      - name: Run host touch replay suite
        run: scripts/test_touch_replay_host.sh
      - name: Host tooling clippy
        run: scripts/lint_host_tools.sh
      - name: Rust analyzer baseline
        run: scripts/lint_rust_analyzer.sh
      - name: Code analysis ratchet
        run: RCA_ENFORCE=1 RCA_RATCHET=1 scripts/lint_code_analysis.sh
